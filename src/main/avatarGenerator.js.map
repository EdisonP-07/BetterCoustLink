{"version":3,"file":"avatarGenerator.js","sourceRoot":"","sources":["avatarGenerator.ts"],"names":[],"mappings":"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","sourcesContent":["import Color from 'color';\nimport jimp from 'jimp';\nimport fs from 'fs';\n\n// @ts-ignore\nimport playerBase from '../../static/images/generate/player.png'; // @ts-ignore\nimport ghostBase from '../../static/images/generate/ghost.png'; // @ts-ignore\nimport { app } from 'electron';\n\nexport const DEFAULT_PLAYERCOLORS = [\n\t['#C51111', '#7A0838'],\n\t['#132ED1', '#09158E'],\n\t['#117F2D', '#0A4D2E'],\n\t['#ED54BA', '#AB2BAD'],\n\t['#EF7D0D', '#B33E15'],\n\t['#F5F557', '#C38823'],\n\t['#3F474E', '#1E1F26'],\n\t['#FFFFFF', '#8394BF'],\n\t['#6B2FBB', '#3B177C'],\n\t['#71491E', '#5E2615'],\n\t['#38FEDC', '#24A8BE'],\n\t['#50EF39', '#15A742'],\n];\n\nfunction pathToHash(input: string): number {\n\tlet hash = 0;\n\tfor (let i = 0; i < input.length; i++) {\n\t\tconst char = input.charCodeAt(i);\n\t\thash = (hash << 5) - hash + char;\n\t\thash = hash & hash; // Convert to 32bit integer\n\t}\n\treturn hash;\n}\n\nexport function numberToColorHex(colour: number): string {\n\treturn (\n\t\t'#' +\n\t\t(colour & 0x00ffffff)\n\t\t\t.toString(16)\n\t\t\t.padStart(6, '0')\n\t\t\t.match(/.{1,2}/g)\n\t\t\t?.reverse()\n\t\t\t.join('')\n\t);\n}\n\n\nasync function colorImages(playerColors: string[][], image: string, imagename: string): Promise<void> {\n\tconst img = await jimp.read(Buffer.from(image.replace(/^data:image\\/png;base64,/, ''), 'base64')); //`${app.getAppPath()}/../test/${imagename}.png`\n\tconst originalData = new Uint8Array(img.bitmap.data);\n\tfor (let colorId = 0; colorId < playerColors.length; colorId++) {\n\t\tconst color = playerColors[colorId][0];\n\t\tconst shadow = playerColors[colorId][1];\n\t\tawait colorImage(\n\t\t\timg,\n\t\t\toriginalData,\n\t\t\tcolor,\n\t\t\tshadow,\n\t\t\t`${app.getPath('userData')}/static/generated/${imagename}/${colorId}.png`\n\t\t);\n\t}\n}\n\nfunction rgb2hsv(r: number, g: number, b: number) {\n\tlet v = Math.max(r, g, b), c = v - Math.min(r, g, b);\n\tlet h = c && ((v == r) ? (g - b) / c : ((v == g) ? 2 + (b - r) / c : 4 + (r - g) / c));\n\treturn [60 * (h < 0 ? h + 6 : h), v && c / v, v];\n}\n\nfunction isBetween(h: number, h1: number, maxdiffrence: number) {\n\treturn 180 - Math.abs(Math.abs(h - h1) - 180) < maxdiffrence;\n}\n\nasync function colorImage(img: jimp, originalData: Uint8Array, color: string, shadow: string, savepath: string, returnImg = false) {\n\timg.bitmap.data = new Uint8Array(originalData) as Buffer;\n\tfor (let i = 0, l = img.bitmap.data.length; i < l; i += 4) {\n\t\tconst data = img.bitmap.data;\n\t\tconst r = data[i];\n\t\tconst g = data[i + 1];\n\t\tconst b = data[i + 2];\n\t\t//   let alpha = data[i + 3];\n\t\tconst h = rgb2hsv(r, g, b);\n\n\t\tif ((h[1] > 0.4) && (isBetween(h[0], 240, 30) || isBetween(h[0], 0, 100) || isBetween(h[0], 120, 40))) { //  )\n\n\t\t\tconst pixelColor = Color('#000000')\n\t\t\t\t.mix(Color(shadow), b / 255)\n\t\t\t\t.mix(Color(color), r / 255)\n\t\t\t\t.mix(Color('#9acad5'), g / 255);\n\t\t\tdata[i] = pixelColor.red();\n\t\t\tdata[i + 1] = pixelColor.green();\n\t\t\tdata[i + 2] = pixelColor.blue();\n\t\t}\n\t}\n\tvar savepathTemp = `${savepath}.${Math.floor(Math.random() * 101)}`;\n\tawait img.writeAsync(savepathTemp);\n\ttry{\n\tawait fs.promises.rename(savepathTemp, savepath);\n\t}\n\tcatch(ex){\n\t\tawait fs.promises.unlink(savepathTemp);\n\t}\n}\n\nexport async function GenerateAvatars(colors: string[][]): Promise<void> {\n\tconsole.log('Generating avatars..', `${app.getPath('userData')}/static/generated/`);\n\ttry {\n\t\tawait colorImages(colors, ghostBase, 'ghost');\n\t\tawait colorImages(colors, playerBase, 'player');\n\t} catch (exception) {\n\t\tconsole.log('error while generating the avatars..', exception);\n\t}\n}\n\nexport async function GenerateHat(imagePath: URL, colors: string[][], colorId: number, path: string) {\n\ttry {\n\t\tconst img = await jimp.read(imagePath.href);\n\t\tconst originalData = new Uint8Array(img.bitmap.data);\n\t\tconst color = colors[colorId][0];\n\t\tconst shadow = colors[colorId][1];\n\n\t\tconst temp = `${app.getPath('userData')}/static/generated/hats/${pathToHash(\n\t\t\timagePath + '/' + color + '/' + shadow\n\t\t)}.png`;\n\t\tif (!fs.existsSync(temp) || Date.now() - (await fs.promises.stat(temp)).mtimeMs > 300000) {\n\t\t\tawait colorImage(img, originalData, color, shadow, temp);\n\t\t}\n\t\treturn temp;\n\n\t} catch (exception) {\n\t\tconsole.log('error while generating the avatars..', exception);\n\t\treturn '';\n\t}\n}\n"]}