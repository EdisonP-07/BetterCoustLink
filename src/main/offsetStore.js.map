{"version":3,"file":"offsetStore.js","sourceRoot":"","sources":["offsetStore.ts"],"names":[],"mappings":"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","sourcesContent":["import Store from 'electron-store';\nimport fetch from 'node-fetch';\nimport Errors from '../common/Errors';\n\nexport interface IOffsetsLookup {\n\tpatterns: {\n\t\tx64: { broadcastVersion: ISignature };\n\t\tx86: { broadcastVersion: ISignature };\n\t};\n\tversions: {\n\t\t[innerNetClientId: string]: {\n\t\t\tversion: string;\n\t\t\tfile: string;\n\t\t\toffsetsVersion: number;\n\t\t};\n\t};\n}\n\ninterface ISignature {\n\tsig: string;\n\taddressOffset: number;\n\tpatternOffset: number;\n}\n\nexport interface IOffsets {\n\tmeetingHud: number[];\n\tobjectCachePtr: number[];\n\tmeetingHudState: number[];\n\tallPlayersPtr: number[];\n\tallPlayers: number[];\n\tplayerCount: number[];\n\tplayerAddrPtr: number;\n\tshipStatus: number[];\n\tlightRadius: number[];\n\tshipStatus_systems: number[];\n\tshipStatus_map: number[];\n\tshipstatus_allDoors: number[];\n\tdoor_doorId: number;\n\tdoor_isOpen: number;\n\tdeconDoorUpperOpen: number[];\n\tdeconDoorLowerOpen: number[];\n\thqHudSystemType_CompletedConsoles: number[];\n\tHudOverrideSystemType_isActive: number[];\n\tminiGame: number[];\n\tplanetSurveillanceMinigame_currentCamera: number[];\n\tplanetSurveillanceMinigame_camarasCount: number[];\n\tsurveillanceMinigame_FilteredRoomsCount: number[];\n\tpalette: number[];\n\tpalette_shadowColor: number[];\n\tpalette_playercolor: number[];\n\tgameoptionsData: number[];\n\tgameOptions_MapId: number[];\n\tgameOptions_MaxPLayers: number[];\n\tconnectFunc: number;\n\tfixedUpdateFunc: number;\n\tshowModStampFunc: number;\n\tmodLateUpdateFunc: number;\n\tpingMessageString: number;\n\tserverManager_currentServer: number[];\n\tinnerNetClient: {\n\t\tbase: number[];\n\t\tnetworkAddress: number;\n\t\tnetworkPort: number;\n\t\tonlineScene: number;\n\t\tmainMenuScene: number;\n\t\tgameMode: number;\n\t\tgameId: number;\n\t\thostId: number;\n\t\tclientId: number;\n\t\tgameState: number;\n\t};\n\tplayer: {\n\t\tisLocal: number[];\n\t\tlocalX: number[];\n\t\tlocalY: number[];\n\t\tremoteX: number[];\n\t\tremoteY: number[];\n\t\troleTeam: number[];\n\t\tnameText?: number[];\n\t\tcurrentOutfit: number[];\n\t\toutfit: {\n\t\t\tcolorId: number[];\n\t\t\tplayerName: number[];\n\t\t\thatId: number[];\n\t\t\tskinId: number[];\n\t\t\tvisorId: number[];\n\t\t};\n\t\tbufferLength: number;\n\t\toffsets: number[];\n\t\tinVent: number[];\n\t\tclientId: number[];\n\t\tisDummy: number[]; // used for muting\n\t\tstruct: {\n\t\t\ttype:\n\t\t\t| 'INT'\n\t\t\t| 'INT_BE'\n\t\t\t| 'UINT'\n\t\t\t| 'UINT_BE'\n\t\t\t| 'SHORT'\n\t\t\t| 'SHORT_BE'\n\t\t\t| 'USHORT'\n\t\t\t| 'USHORT_BE'\n\t\t\t| 'FLOAT'\n\t\t\t| 'CHAR'\n\t\t\t| 'BYTE'\n\t\t\t| 'SKIP';\n\t\t\tskip?: number;\n\t\t\tname: string;\n\t\t}[];\n\t};\n\tsignatures: {\n\t\tinnerNetClient: ISignature;\n\t\tmeetingHud: ISignature;\n\t\tgameData: ISignature;\n\t\tshipStatus: ISignature;\n\t\tminiGame: ISignature;\n\t\tpalette: ISignature;\n\t\tplayerControl: ISignature;\n\t\tconnectFunc: ISignature;\n\t\tfixedUpdateFunc: ISignature;\n\t\tpingMessageString: ISignature;\n\t\tserverManager: ISignature;\n\t\tshowModStamp: ISignature;\n\t\tmodLateUpdate: ISignature;\n\t\tgameOptionsManager: ISignature;\n\t};\n\toldMeetingHud: boolean;\n\tdisableWriting: boolean;\n\tnewGameOptions: boolean;\n}\n\ninterface IOffsetsStore {\n\tfilename: string;\n\tis_64bit: boolean;\n\toffsetsVersion: number;\n\toffsets: IOffsets;\n}\n//// \"https://cdn.jsdelivr.net/gh/OhMyGuus/BetterCrewlink-Offsets@main/\"; // \"https://raw.githubusercontent.com/OhMyGuus/BetterCrewlink-Offsets/main\"\n\nconst BASE_URL = \"https://raw.githubusercontent.com/OhMyGuus/BetterCrewlink-Offsets/main\";\nconst BASE_URL_error = \"https://cdn.jsdelivr.net/gh/OhMyGuus/BetterCrewlink-Offsets@main\";\n\nconst store = new Store<IOffsetsStore>({name: \"offsets\"});\nconst lookupStore = new Store<IOffsetsLookup>({name: \"lookup\"});\n\nasync function fetchOffsetLookupJson(error: boolean = false): Promise<IOffsetsLookup> {\n    const url = error ? BASE_URL_error : BASE_URL;\n    return fetch(`${url}/lookup.json`)\n        .then((response) => response.json())\n        .then((data) => { return data as IOffsetsLookup })\n        .catch((_) => {\n            if (!error) {\n                return fetchOffsetLookupJson(true);\n            } else {\n                throw Errors.LOOKUP_FETCH_ERROR;\n            }\n        });\n}\n\nexport async function fetchOffsetLookup(): Promise<IOffsetsLookup> {\n\ttry {\n\t\tconst lookups = await fetchOffsetLookupJson();\n\t\tlookupStore.set(lookups);\n\t\treturn lookups;\n\t} catch {\n\t\t// Check if cache file has never been generated\n\t\tif (!lookupStore.get('patterns')) throw Errors.LOOKUP_FETCH_ERROR;\n\t\treturn lookupStore.store\n\t}\n}\n\nasync function fetchOffsetsJson(is_64bit: boolean, filename: string, error: boolean = false): Promise<IOffsets> {\n    const url = error ? BASE_URL_error : BASE_URL;\n    const OFFSETS_URL = `${url}/offsets`;\n    return fetch(`${OFFSETS_URL}/${is_64bit ? 'x64' : 'x86'}/${filename}`)\n        .then((response) => response.json())\n        .then((data) => { return data as IOffsets })\n        .catch((_) => {\n            if (!error) {\n                return fetchOffsetsJson(is_64bit, filename, true);\n            } else {\n                throw Errors.OFFSETS_FETCH_ERROR;\n            }\n        });\n}\nexport async function fetchOffsets(is_64bit: boolean, filename: string, offsetsVersion: number): Promise<IOffsets> {\n\t// offsetsVersion in case we need to update people's cached file\n\t// >= version to allow testing with local file updates (eg remote vers 2, local vers 3)\n\t// no need to host local http server\n\tif (store.get('filename')  == filename && store.get('is_64bit') == is_64bit && store.get('offsetsVersion') >= offsetsVersion) {\n\t\tconsole.log(\"Loading cached offsets\");\n\t\treturn store.get('IOffsets');\n\t}\n\tconst offsets = await fetchOffsetsJson(is_64bit, filename);\n\tstore.set('filename', filename);\n\tstore.set('is_64bit', is_64bit);\n\tstore.set('offsetsVersion', offsetsVersion ? offsetsVersion : 0);\n\tstore.set('IOffsets', offsets);\n\treturn offsets;\n}"]}