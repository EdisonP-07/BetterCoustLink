{"version":3,"file":"ConnectionController.js","sourceRoot":"","sources":["ConnectionController.ts"],"names":[],"mappings":"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","sourcesContent":["// import { EventEmitter as EventEmitterO } from 'events';\n// import Peer from 'simple-peer';\n// import * as io from 'socket.io-client';\n// import { AmongUsState, GameState, Player } from './AmongUsState';\n// import { SocketElementMap, SocketElement, Client, AudioElement, SocketClientMap } from './smallInterfaces';\n// import { audioController } from './AudioController';\n\n// const DEFAULT_ICE_CONFIG: RTCConfiguration = {\n// \ticeServers: [\n// \t\t{\n// \t\t\turls: 'stun:stun.l.google.com:19302',\n// \t\t},\n// \t\t{\n// \t\t\turls: 'turn:crewlink.guus.info:3478',\n// \t\t\tusername: 'M9DRVaByiujoXeuYAAAG',\n// \t\t\tcredential: 'TpHR9HQNZ8taxjb3',\n// \t\t}\n// \t],\n// };\n\n// export enum ConnectionState {\n// \tdisconnected = 0,\n// \tconnecting = 1,\n// \tconencted = 2,\n// }\n\n// export declare interface IConnectionController {\n// \tcurrentGameState: AmongUsState;\n// \tconnectionState: ConnectionState;\n// }\n\n// declare interface ConnectionController {\n// \ton(event: 'onstream', listener: (e: MediaStream) => void): this;\n// \ton(event: 'gamestateChange', listener: (e: AmongUsState) => void): this;\n// }\n\n// class ConnectionController extends EventEmitterO implements IConnectionController {\n// \tsocketIOClient: SocketIOClient.Socket;\n// \tpublic currentGameState: AmongUsState;\n// \tsocketElements: SocketElementMap = new SocketElementMap();\n// \tamongusUsername: string;\n// \tcurrenGameCode: string;\n// \tpublic connectionState = ConnectionState.disconnected;\n// \tgamecode: string;\n// \tlocalPLayer: Player;\n// \tdeviceID: string;\n\n// \tprivate getSocketElement(socketId: string): SocketElement {\n// \t\tif (!this.socketElements.has(socketId)) {\n// \t\t\tthis.socketElements.set(socketId, new SocketElement(socketId));\n// \t\t}\n// \t\treturn this.socketElements.get(socketId);\n// \t}\n\n// \tgetPlayer(clientId: number): Player {\n// \t\t// cache clientid & socketid\n// \t\treturn this.currentGameState.players.find((o) => o.clientId === clientId);\n// \t}\n\n// \tconnect(voiceserver: string, gamecode: string, username: string, deviceID: string) {\n// \t\tthis.connectionState = ConnectionState.connecting;\n// \t\tthis.gamecode = gamecode;\n// \t\tthis.amongusUsername = username;\n// \t\tthis.deviceID = deviceID;\n// \t\tthis.initialize(voiceserver);\n// \t\tthis.socketIOClient.emit('join', this.gamecode + '_mobile', Number(Date.now()), Number(Date.now()));\n// \t}\n\n// \tdisconnect() {\n// \t\tthis.connectionState = ConnectionState.disconnected;\n// \t\tthis.gamecode = '';\n// \t\tthis.amongusUsername = '';\n// \t\tthis.socketIOClient.emit('leave');\n// \t\tthis.socketIOClient.disconnect();\n// \t\tthis.disconnectSockets();\n// \t}\n\n// \tprivate disconnectElement(element: SocketElement) {\n// \t\tconsole.log('disconnectElement!!!');\n// \t\tif (!element) {\n// \t\t\treturn;\n// \t\t}\n// \t\tthis.socketElements.delete(element.socketId);\n// \t\taudioController.disconnectElement(element);\n// \t}\n\n// \tprivate disconnectSockets() {\n// \t\tfor (const element of this.socketElements.values()) {\n// \t\t\tthis.disconnectElement(element);\n// \t\t}\n// \t}\n\n// \t// move to different controller\n// \tprivate async startAudio() {\n// \t\tawait audioController.startAudio();\n\n// \t\tthis.socketIOClient.on('join', async (peerId: string, client: Client) => {\n// \t\t\tconsole.log('[client.join]', { peerId, client });\n// \t\t\tconst element = this.getSocketElement(peerId);\n// \t\t\telement.client = client;\n// \t\t\tthis.ensurePeerConnection(element, true);\n// \t\t});\n// \t}\n\n// \tprivate ensurePeerConnection(element: SocketElement, initiator: boolean) {\n// \t\tif (!element.peer) {\n// \t\t\telement.peer = this.createPeerConnection(element.socketId, audioController.stream, initiator);\n// \t\t}\n// \t}\n\n// \tprivate createPeerConnection(socketId: string, stream: MediaStream, initiator): Peer {\n// \t\tconsole.log('[createPeerConnection], ', { peerId: socketId });\n// \t\tconst peer: Peer = new Peer({\n// \t\t\tstream,\n// \t\t\tinitiator, // @ts-ignore-line\n// \t\t\ticeRestartEnabled: false,\n// \t\t\tconfig: DEFAULT_ICE_CONFIG,\n// \t\t});\n\n// \t\tpeer.on('stream', (recievedDtream: MediaStream) => {\n// \t\t\tthis.emit('onstream', recievedDtream);\n// \t\t\tconsole.log('stream recieved', { recievedDtream });\n// \t\t\tthis.getSocketElement(socketId).audioElement = audioController.createAudioElement(recievedDtream);\n// \t\t\tconsole.log(this.getSocketElement(socketId).audioElement);\n// \t\t});\n\n// \t\tpeer.on('signal', (data) => {\n// \t\t\tthis.socketIOClient.emit('signal', {\n// \t\t\t\tdata,\n// \t\t\t\tto: socketId,\n// \t\t\t});\n// \t\t});\n\n// \t\tpeer.on('close', () => {\n// \t\t\tconsole.log('PEER ON CLOSE?');\n// \t\t\tconst socketElement = this.getSocketElement(socketId);\n// \t\t\taudioController.disconnectElement(socketElement);\n// \t\t});\n\n// \t\tpeer.on('error', (err) => {\n// \t\t\tconsole.log('PEER ON error? : ', err);\n// \t\t});\n\n// \t\tconsole.log('peerConnections', this.socketElements);\n// \t\treturn peer;\n// \t}\n\n// \tprivate onGameStateChange(amongUsState: AmongUsState) {\n// \t\tthis.currentGameState = amongUsState;\n// \t\tthis.localPLayer = amongUsState.players.filter((o) => o.name === this.amongusUsername)[0];\n// \t\tif (!this.localPLayer) {\n// \t\t\treturn;\n// \t\t}\n\n// \t\tif (this.connectionState === ConnectionState.connecting || this.currenGameCode !== this.gamecode) {\n// \t\t\tthis.currenGameCode = this.gamecode;\n// \t\t\tconsole.log(this.localPLayer);\n// \t\t\tthis.startAudio().then(() => {\n// \t\t\t\tthis.socketIOClient.emit('id', this.localPLayer.id, this.localPLayer.clientId);\n// \t\t\t\tthis.socketIOClient.emit('join', this.gamecode, this.localPLayer.id, this.localPLayer.clientId);\n// \t\t\t});\n// \t\t\tthis.connectionState = ConnectionState.conencted;\n// \t\t}\n\n// \t\tthis.socketElements.forEach((value) => {\n// \t\t\tvalue.updatePLayer();\n// \t\t\taudioController.updateAudioLocation(this.currentGameState, value, this.localPLayer);\n// \t\t});\n// \t}\n\n// \tprivate initialize(serverUrl: string) {\n// \t\tthis.socketIOClient?.disconnect();\n// \t\tconsole.log('[Connect] got called');\n// \t\tthis.socketIOClient = io(serverUrl, {\n// \t\t\ttransports: ['websocket'],\n// \t\t});\n\n// \t\tthis.socketIOClient.on('error', (error: string) => {\n// \t\t\tconsole.log('[client.error', error);\n// \t\t});\n// \t\tthis.socketIOClient.on('connect', () => {\n// \t\t\tconsole.log('[client.connect]');\n// \t\t});\n// \t\tthis.socketIOClient.on('disconnect', () => {\n// \t\t\tconsole.log('[client.disconnect]');\n// \t\t});\n\n// \t\tthis.socketIOClient.on('setClient', (socketId: string, client: Client) => {\n// \t\t\tconsole.log('[client.setClient]', { socketId, client });\n// \t\t\tthis.getSocketElement(socketId).client = client;\n// \t\t});\n\n// \t\tthis.socketIOClient.on('setClients', (clients: SocketClientMap) => {\n// \t\t\tconsole.log('[client.setClients]', { clients });\n// \t\t\tfor (const socketId of Object.keys(clients)) {\n// \t\t\t\tthis.getSocketElement(socketId).client = clients[socketId];\n// \t\t\t}\n// \t\t});\n\n// \t\tthis.socketIOClient.on('signal', ({ data, from }: { data: any; from: string }) => {\n// \t\t\tif (data.hasOwnProperty('gameState')) {\n// \t\t\t\t//\tconsole.log('gamestateupdate?');\n// \t\t\t\tthis.onGameStateChange(data as AmongUsState);\n// \t\t\t\treturn;\n// \t\t\t}\n\n// \t\t\tif (!audioController.stream) {\n// \t\t\t\treturn;\n// \t\t\t}\n// \t\t\tconst socketElement = this.getSocketElement(from);\n// \t\t\tthis.ensurePeerConnection(socketElement, false);\n// \t\t\tsocketElement.peer.signal(data);\n// \t\t});\n// \t}\n// }\n\n// export const connectionController = new ConnectionController();\n"]}